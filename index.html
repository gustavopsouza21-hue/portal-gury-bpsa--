<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gury Intelligence | Fiscal Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary: #1e3a8a; --primary-light: #3b82f6; --accent: #facc15;
            --danger: #ef4444; --success: #22c55e; --dark: #0f172a;
            --surface: #ffffff; --background: #f1f5f9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: var(--background); color: var(--dark); overflow-x: hidden; }

        /* --- TELA DE ACESSO --- */
        #login-overlay {
            position: fixed; inset: 0; z-index: 10000;
            background: radial-gradient(circle at top left, var(--primary), #000);
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: var(--surface); padding: 3.5rem; border-radius: 2.5rem; width: 440px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .login-box img { width: 220px; margin-bottom: 2.5rem; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.1)); }
        .input-group { margin-bottom: 1.2rem; text-align: left; }
        .input-group label { display: block; font-size: 0.8rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; padding-left: 0.5rem; }
        .input-group input { 
            width: 100%; padding: 1.1rem; border-radius: 1.2rem; border: 2px solid #f1f5f9;
            background: #f8fafc; font-size: 1rem; transition: 0.3s;
        }
        .input-group input:focus { border-color: var(--primary); background: #fff; outline: none; box-shadow: 0 0 0 4px rgba(30,58,138,0.1); }

        /* --- HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px);
            padding: 0.8rem 4%; display: flex; justify-content: space-between;
            align-items: center; position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .search-wrapper { position: relative; flex: 1; max-width: 600px; margin: 0 3rem; }
        .search-wrapper input {
            width: 100%; padding: 0.9rem 1rem 0.9rem 3.5rem; border-radius: 1.2rem;
            border: 1px solid #e2e8f0; background: #fff; font-weight: 500;
        }
        .search-wrapper i { position: absolute; left: 1.2rem; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        /* --- DASHBOARD --- */
        .main-content { max-width: 1600px; margin: 2.5rem auto; padding: 0 2rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
        .stat-card {
            background: var(--surface); padding: 2rem; border-radius: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.03);
            display: flex; align-items: center; gap: 1.5rem; position: relative; overflow: hidden;
        }
        .stat-card::after { content: ''; position: absolute; bottom: 0; left: 0; height: 5px; width: 100%; background: var(--primary); opacity: 0.1; }
        .stat-icon { font-size: 1.8rem; padding: 1.2rem; border-radius: 1.2rem; background: #f0f7ff; color: var(--primary); }

        /* --- TABS --- */
        .nav-tabs { display: flex; gap: 10px; background: #e2e8f0; padding: 8px; border-radius: 1.5rem; width: fit-content; margin: 0 auto 3rem; }
        .tab-trigger {
            padding: 0.9rem 2.5rem; border: none; border-radius: 1.1rem;
            cursor: pointer; font-weight: 700; color: #64748b; background: transparent; transition: 0.3s;
        }
        .tab-trigger.active { background: var(--surface); color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        /* --- UPLOAD AREA --- */
        .upload-portal {
            background: var(--surface); border: 3px dashed #cbd5e1; border-radius: 2.5rem;
            padding: 5rem 2rem; text-align: center; cursor: pointer; transition: 0.4s; margin-bottom: 4rem;
        }
        .upload-portal:hover { border-color: var(--primary); background: #f8fafc; transform: translateY(-3px); }
        .upload-portal i { font-size: 4rem; color: var(--primary); margin-bottom: 1.5rem; animation: bounce 2s infinite; }

        /* --- NOTA CARDS --- */
        .notes-display { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2.5rem; }
        .nota-wrapper {
            background: var(--surface); border-radius: 2.2rem; overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.03); border: 1px solid #f1f5f9;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative;
        }
        .nota-wrapper:hover { transform: scale(1.03); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.08); }
        .nota-wrapper img { width: 100%; height: 250px; object-fit: cover; cursor: pointer; }
        
        .nota-details { padding: 1.8rem; }
        .nota-details input {
            width: 100%; border: 2px solid #f1f5f9; background: #f8fafc; padding: 0.8rem;
            border-radius: 1rem; font-weight: 800; color: var(--primary); margin-bottom: 12px; font-size: 1.05rem;
        }
        .nota-footer { display: flex; justify-content: space-between; font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; }

        /* --- BOTÕES --- */
        .btn { padding: 0.9rem 1.8rem; border-radius: 1.1rem; border: none; font-weight: 800; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .btn-main { background: var(--primary); color: white; }
        .btn-main:hover { background: var(--dark); transform: translateY(-2px); }
        .btn-ghost { background: #fee2e2; color: var(--danger); }

        /* --- ANIMATIONS --- */
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* --- NOTIFICAÇÃO --- */
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--dark); color: white; padding: 1rem 2.5rem; border-radius: 50px;
            font-weight: 600; z-index: 10000; display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <div id="toast">Operação realizada!</div>

    <div id="login-overlay">
        <div class="login-box">
            <img src="https://i.ibb.co/GvxS07W/images.png" alt="Gury Logo">
            <div class="input-group">
                <label>Identificação</label>
                <input type="text" id="userIn" placeholder="Nome do Responsável">
            </div>
            <div class="input-group">
                <label>Código de Segurança</label>
                <input type="password" id="passIn" placeholder="••••••••">
            </div>
            <button class="btn btn-main" style="width: 100%; justify-content: center; margin-top: 2rem;" onclick="Core.login()">Acessar Intelligence</button>
        </div>
    </div>

    <div id="app-root" style="display:none">
        <header>
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="https://i.ibb.co/GvxS07W/images.png" height="40">
                <div style="width: 2px; height: 30px; background: #e2e8f0;"></div>
                <span style="font-weight: 800; color: var(--primary); letter-spacing: -1px;">FISCAL PRO</span>
            </div>

            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="query" placeholder="Pesquisar por fornecedor, data ou operador..." onkeyup="Core.render()">
            </div>

            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-main" onclick="Core.export()"><i class="fas fa-file-zipper"></i> BACKUP COMPLETO</button>
                <button class="btn btn-ghost" onclick="location.reload()">SAIR</button>
            </div>
        </header>

        <main class="main-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-industry"></i></div>
                    <div><h3>Unidade Gury</h3><p id="total-gury">0</p></div>
                </div>
                <div class="stat-card" style="border-left: 6px solid var(--danger)">
                    <div class="stat-icon" style="background:#fef2f2; color:var(--danger)"><i class="fas fa-truck-loading"></i></div>
                    <div><h3>Unidade BPSA</h3><p id="total-bpsa">0</p></div>
                </div>
                <div class="stat-card" style="border-left: 6px solid var(--success)">
                    <div class="stat-icon" style="background:#f0fdf4; color:var(--success)"><i class="fas fa-user-tie"></i></div>
                    <div><h3>Responsável</h3><p id="user-display">---</p></div>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="tab-trigger active" id="t-gury" onclick="Core.switch('gury')">MATRIZ GURY</button>
                <button class="tab-trigger" id="t-bpsa" onclick="Core.switch('bpsa')">FILIAL BPSA</button>
            </div>

            <div class="upload-portal" onclick="document.getElementById('file-input').click()">
                <i class="fas fa-cloud-arrow-up"></i>
                <h1 style="font-weight: 800; font-size: 2rem; margin-bottom: 0.5rem;">Importação Direta <span id="label-unit" style="color:var(--primary)">GURY</span></h1>
                <p style="color: var(--slate); font-weight: 500;">Clique para escanear ou selecione fotos da galeria</p>
                <input type="file" id="file-input" multiple accept="image/*" hidden onchange="Core.upload(this)">
            </div>

            <div class="notes-display" id="grid"></div>
        </main>
    </div>

    <div id="viewer" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.98); z-index:99999; justify-content:center; align-items:center;" onclick="this.style.display='none'">
        <img src="" id="view-img" style="max-width:95%; max-height:90vh; border-radius:1.5rem; box-shadow: 0 0 50px rgba(0,0,0,0.5);">
    </div>

    <script>
        const db = new Dexie("GuryFiscal_Enterprise");
        db.version(1).stores({ notas: "++id, name, unit, user, date, timestamp" });

        const Core = {
            activeUser: "",
            activeUnit: "gury",

            login() {
                const u = document.getElementById('userIn').value;
                if(u.length > 2) {
                    this.activeUser = u.toUpperCase();
                    document.getElementById('user-display').innerText = this.activeUser;
                    document.getElementById('login-overlay').style.fadeOut = 300;
                    setTimeout(() => {
                        document.getElementById('login-overlay').style.display = 'none';
                        document.getElementById('app-root').style.display = 'block';
                        this.render();
                    }, 300);
                }
            },

            switch(u) {
                this.activeUnit = u;
                document.querySelectorAll('.tab-trigger').forEach(t => t.classList.remove('active'));
                document.getElementById('t-'+u).classList.add('active');
                document.getElementById('label-unit').innerText = u.toUpperCase();
                this.render();
            },

            async upload(el) {
                const files = Array.from(el.files);
                if(!files.length) return;

                this.notify(`Processando ${files.length} arquivos...`);

                for(let file of files) {
                    const base64 = await this.optimize(file);
                    await db.notas.add({
                        name: file.name.split('.')[0],
                        img: base64,
                        unit: this.activeUnit,
                        user: this.activeUser,
                        date: new Date().toLocaleDateString('pt-BR'),
                        timestamp: Date.now()
                    });
                }
                el.value = "";
                this.render();
                this.notify("Sincronização concluída!");
            },

            optimize(file) {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_W = 1400;
                            const scale = MAX_W / img.width;
                            canvas.width = MAX_W;
                            canvas.height = img.height * scale;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toBase64 ? canvas.toBase64('image/jpeg', 0.8) : canvas.toDataURL('image/jpeg', 0.8));
                        }
                    }
                });
            },

            async render() {
                const search = document.getElementById('query').value.toLowerCase();
                const grid = document.getElementById('grid');
                grid.innerHTML = "";

                const items = await db.notas.where('unit').equals(this.activeUnit).reverse().toArray();
                
                document.getElementById('total-gury').innerText = await db.notas.where('unit').equals('gury').count();
                document.getElementById('total-bpsa').innerText = await db.notas.where('unit').equals('bpsa').count();

                items.forEach(nota => {
                    if(nota.name.toLowerCase().includes(search) || nota.date.includes(search)) {
                        const card = document.createElement('div');
                        card.className = 'nota-wrapper';
                        card.innerHTML = `
                            <button onclick="Core.delete(${nota.id})" style="position:absolute; top:15px; right:15px; border:none; background:var(--danger); color:white; width:40px; height:40px; border-radius:12px; cursor:pointer; z-index:10;"><i class="fas fa-trash"></i></button>
                            <img src="${nota.img}" onclick="Core.zoom('${nota.img}')">
                            <div class="nota-details">
                                <input type="text" value="${nota.name}" onchange="Core.update(${nota.id}, this.value)">
                                <div class="nota-footer">
                                    <span><i class="fas fa-user-circle"></i> ${nota.user}</span>
                                    <span><i class="fas fa-calendar-day"></i> ${nota.date}</span>
                                </div>
                            </div>
                        `;
                        grid.appendChild(card);
                    }
                });
            },

            async update(id, val) { await db.notas.update(id, {name: val}); this.notify("Nome atualizado!"); },
            
            async delete(id) {
                if(confirm("Deseja permanentemente excluir este registro?")) {
                    await db.notas.delete(id);
                    this.render();
                    this.notify("Registro excluído.");
                }
            },

            zoom(s) { 
                document.getElementById('view-img').src = s;
                document.getElementById('viewer').style.display = 'flex';
            },

            notify(m) {
                const t = document.getElementById('toast');
                t.innerText = m; t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            },

            async export() {
                this.notify("Gerando pacote ZIP...");
                const zip = new JSZip();
                const data = await db.notas.toArray();
                
                data.forEach(n => {
                    zip.folder(n.unit.toUpperCase()).file(`${n.name}_${n.date.replace(/\//g,'-')}.jpg`, n.img.split(',')[1], {base64: true});
                });

                const blob = await zip.generateAsync({type:"blob"});
                saveAs(blob, `GURY_BPSA_FULL_BACKUP_${Date.now()}.zip`);
                this.notify("Download iniciado!");
            }
        };
    </script>
</body>
</html>
